{
	"name": "listings_by_date_and_building_type",
	"properties": {
		"content": {
			"query": "WITH latest_day AS (\n SELECT AddressTextHash\n FROM [realtor_lake].[dbo].[listings_silver]\n WHERE source_file = (SELECT MAX(source_file) FROM [realtor_lake].[dbo].[listings_silver])\n AND BuildingType = 'House'\n),\nd_rank AS (\n    SELECT ListingId, MlsNumber, AddressTextHash, AddressText, ListingInsertedDateMT, PriceUnformattedValue, PriceChangeDateUTC, PriceChangeDateTimeStampUTC, PriceChangeDateMT, DENSE_RANK() OVER (PARTITION BY AddressText ORDER BY ListingId) drank\n    FROM [realtor_lake].[dbo].[listings_silver]\n    WHERE BuildingType = 'House'\n)\nSELECT d.*\nFROM d_rank D\nJOIN latest_day l ON l.AddressTextHash = d.AddressTextHash \n--WHERE AddressText = '334 Bridleridge Way SW|Calgary, Alberta T2Y4M6'\nWHERE d.AddressTextHash IN (SELECT DISTINCT AddressTextHash FROM d_rank WHERE drank = 2) \n;\n-- select top 10 AddressTextHash from [realtor_lake].[dbo].[listings_silver]\n\n-- SELECT \n--  source_file, BuildingType, COUNT(1) cnt, CEILING(AVG(PriceUnformattedValue)) AS avg_price\n-- FROM [realtor_lake].[dbo].[listings_bronze]\n-- --WHERE [source_file] = '2023-08-26'\n-- --   and buildingtype = 'House'\n-- GROUP BY source_file, BuildingType\n-- ORDER BY source_file DESC, BuildingType ASC\n--  ;\n\n-- SELECT \n-- month, BuildingType, COUNT(1) cnt, CEILING(AVG(PriceUnformattedValue))  AS avg_price\n-- FROM [realtor_lake].[dbo].[listings_bronze]\n-- --WHERE [source_file] = '2023-08-26'\n-- --   and buildingtype = 'House'\n-- GROUP BY month, BuildingType\n-- ORDER BY month DESC, BuildingType ASC\n-- ;\n\n-- SELECT TOP 10\n--  last_modified_time, PriceChangeDateUTC\n-- FROM [realtor_lake].[dbo].[listings_bronze];\n\n-- SELECT \n--  source_file, BuildingType, COUNT(1) cnt\n-- FROM [realtor_lake].[dbo].[listings_silver]\n-- --WHERE [source_file] = '2023-08-26' and buildingtype = 'House'\n-- GROUP BY source_file, BuildingType\n-- ORDER BY source_file DESC, BuildingType ASC\n--  ;\n\n-- SELECT TOP 100 *\n-- FROM listings_silver;\n-- -- DELETE FROM [realtor_lake].[dbo].[listings]\n-- -- WHERE [source_file] = '2023-07-14';",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "realtor_lake",
				"poolName": "Built-in"
			},
			"resultLimit": -1
		},
		"type": "SqlQuery"
	}
}